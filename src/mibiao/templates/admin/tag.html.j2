<script id="tag" type="text/x-template">
  <div>
    <el-button type="primary" class="mb-1" @click="handleCreate">Ê∑ªÂä†Ê†áÁ≠æ</el-button>
    <el-table :data="tableData" style="width: 100%" height="666">
      <el-table-column fixed prop="name" label="Ê†áÁ≠æ" width="150"></el-table-column>
      <el-table-column prop="url_path_name" label="URLË∑ØÂæÑÂêç" width="150"></el-table-column>
      <el-table-column prop="is_hide" label="ÊòØÂê¶ÈöêËóè" width="120">
        <template #default="scope">
          @{ scope.row.is_hide ? 'Â∑≤ÈöêËóè' : 'ÂàóË°®ÂèØËßÅüëÄ'}
        </template>
      </el-table-column>
      <el-table-column prop="rank" label="ÊéíÂ∫è" width="80"></el-table-column>
      <el-table-column prop="display_created_at" label="ÂàõÂª∫Êó∂Èó¥" width="180"></el-table-column>
      <el-table-column prop="display_updated_at" label="Êõ¥Êñ∞Êó∂Èó¥" width="180"></el-table-column>
      <el-table-column fixed="right" label="Êìç‰Ωú" width="100">
        <template #default="scope">
          <el-button link type="primary" size="small" @click="handleEdit(scope.row)">ÁºñËæë</el-button>
          <el-button link type="danger" size="small" @click="handleDelete(scope.row)">Âà†Èô§</el-button>
        </template>
      </el-table-column>
    </el-table>

    <!--Êñ∞Â¢û-->
    <el-dialog v-model="isCreateDialogVisible" title="Êñ∞Â¢ûÊ†áÁ≠æ" width="30%" :beforeClose="handleCreateDialogClose">
      <el-form :model="createFormData" label-width="auto" label-position="right">
        <el-form-item label="Ê†áÁ≠æ">
          <el-input v-model="createFormData.name" placeholder="example.com"/>
        </el-form-item>
        <el-form-item label="URLË∑ØÂæÑÂêç">
          <el-input v-model="createFormData.url_path_name" placeholder="example.com"/>
        </el-form-item>
        <el-form-item label="ÊòØÂê¶ÈöêËóè">
          <el-switch v-model="createFormData.is_hide"/>
        </el-form-item>
        <el-form-item label="ÊéíÂ∫è">
          <el-input-number v-model="createFormData.rank"/>
        </el-form-item>
        <el-divider border-style="dashed"></el-divider>
      </el-form>
      <template #footer>
      <span class="dialog-footer">
        <el-button @click="handleCreateDialogCancel">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="handleCreateDialogSubmit">Êèê‰∫§</el-button>
      </span>
      </template>
    </el-dialog>

    <!--ÁºñËæë-->
    <el-dialog v-model="isEditDialogVisible" title="ÁºñËæëÊ†áÁ≠æ" width="30%" :beforeClose="handleEditDialogClose">
      <el-form :model="editFormData" label-width="auto" label-position="right">
        <el-form-item label="Ê†áÁ≠æ">
          <el-input v-model="editFormData.name" placeholder="example.com"/>
        </el-form-item>
        <el-form-item label="URLË∑ØÂæÑÂêç">
          <el-input v-model="editFormData.url_path_name" placeholder="example.com"/>
        </el-form-item>
        <el-form-item label="ÊòØÂê¶ÈöêËóè">
          <el-switch v-model="editFormData.is_hide"/>
        </el-form-item>
        <el-form-item label="ÊéíÂ∫è">
          <el-input-number v-model="editFormData.rank"/>
        </el-form-item>
        <el-divider border-style="dashed"></el-divider>
      </el-form>
      <template #footer>
      <span class="dialog-footer">
        <el-button @click="handleEditDialogCancel">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="handleEditDialogSubmit">‰øùÂ≠ò</el-button>
      </span>
      </template>
    </el-dialog>

    <!--Âà†Èô§-->
    <el-dialog v-model="isDeleteDialogVisible" title="Á°ÆÂÆöË¶ÅÂà†Èô§ÂêóÔºü" width="30%" :beforeClose="handleDeleteDialogClose">
      <el-form :model="deleteFormData" :disabled="true" label-width="auto" label-position="right">
        <el-form-item label="Ê†áÁ≠æ">
          <el-input v-model="deleteFormData.name"/>
        </el-form-item>
        <el-form-item label="URLË∑ØÂæÑÂêç">
          <el-input v-model="deleteFormData.url_path_name" placeholder="example.com"/>
        </el-form-item>
        <el-form-item label="ÊòØÂê¶ÈöêËóè">
          <el-switch v-model="deleteFormData.is_hide"/>
        </el-form-item>
        <el-form-item label="ÊéíÂ∫è">
          <el-input-number v-model="deleteFormData.rank"/>
        </el-form-item>
        <el-divider border-style="dashed"></el-divider>
      </el-form>
      <template #footer>
      <span class="dialog-footer">
        <el-button @click="handleDeleteDialogCancel">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="handleDeleteDialogSubmit">Á°ÆÂÆö</el-button>
      </span>
      </template>
    </el-dialog>
  </div>
</script>

<script>
  const tag_component = {
    template: `#tag`,
    delimiters: ['@{', '}'],
    setup() {
      onMounted(async () => {
        await refreshTableData();
      });

      /* ÂàóË°® */
      const tableData = ref([]);

      async function refreshTableData() {
        const { tag_list } = await getTagList();
        tableData.value = tag_list;
      }

      /* Êñ∞Â¢û */
      const createFormData = ref({
        name: '',
        url_path_name: '',
        rank: 0,
        is_hide: false,
      });
      const isCreateDialogVisible = ref(false);

      async function handleCreate() {
        isCreateDialogVisible.value = true;
      }

      async function handleCreateDialogClose(done) {
        await handleCreateDialogCancel();
        done();
      }

      async function handleCreateDialogCancel() {
        isCreateDialogVisible.value = false;
        createFormData.value = {};
      }

      async function handleCreateDialogSubmit() {
        await createTag(JSON.stringify({ tag: createFormData.value }));
        await refreshTableData();
        ElMessage({ message: 'Â∑≤Êñ∞Â¢ûÔºÅ', type: 'success' });
        await handleCreateDialogCancel();
      }

      /* ÁºñËæë */
      const editFormData = ref({
        id: 0,
        name: '',
        url_path_name: '',
        rank: 0,
        is_hide: false,
      });
      const isEditDialogVisible = ref(false);

      async function handleEdit(tableRowData) {
        editFormData.value = Object.assign({}, tableRowData);
        isEditDialogVisible.value = true;
      }

      async function handleEditDialogClose(done) {
        await handleEditDialogCancel();
        done();
      }

      async function handleEditDialogCancel() {
        isEditDialogVisible.value = false;
        editFormData.value = {};
      }

      async function handleEditDialogSubmit() {
        await updateTag(
          editFormData.value.id,
          JSON.stringify({ tag: editFormData.value })
        );
        await refreshTableData();
        ElMessage({ message: 'Â∑≤‰øùÂ≠òÔºÅ', type: 'success' });
        await handleEditDialogCancel();
      }

      /* Âà†Èô§*/
      const deleteFormData = ref({
        id: 0,
        name: '',
        url_path_name: '',
        rank: 0,
        is_hide: false,
      });
      const isDeleteDialogVisible = ref(false);

      async function handleDelete(tableRowData) {
        deleteFormData.value = Object.assign({}, tableRowData);
        isDeleteDialogVisible.value = true;
      }

      async function handleDeleteDialogClose(done) {
        await handleDeleteDialogCancel();
        done();
      }

      async function handleDeleteDialogCancel() {
        isDeleteDialogVisible.value = false;
        deleteFormData.value = {};
      }

      async function handleDeleteDialogSubmit() {
        await deleteTag(deleteFormData.value.id);
        await refreshTableData();
        ElMessage({ message: 'Âà†Èô§ÊàêÂäüÔºÅ', type: 'success' });
        await handleDeleteDialogCancel();
      }

      return {
        tableData,

        createFormData,
        isCreateDialogVisible,
        handleCreate,
        handleCreateDialogClose,
        handleCreateDialogCancel,
        handleCreateDialogSubmit,

        editFormData,
        isEditDialogVisible,
        handleEdit,
        handleEditDialogClose,
        handleEditDialogCancel,
        handleEditDialogSubmit,

        deleteFormData,
        isDeleteDialogVisible,
        handleDelete,
        handleDeleteDialogClose,
        handleDeleteDialogCancel,
        handleDeleteDialogSubmit,
      };
    },
  };

  routes.push({
    path: '/tag',
    name: 'tag',
    title: 'Ê†áÁ≠æ',
    component: tag_component,
  });
</script>